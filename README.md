
# üìò Documentation Projet Classcord

**Installation, d√©ploiement, s√©curisation et maintenance**  
_Mise √† jour : 18 juin 2025_

---

## üìï Jour 1 - Lundi : Prise en main, ex√©cution locale et configuration VM

### Objectifs p√©dagogiques
- Comprendre le fonctionnement du serveur Python
- Cr√©er une machine virtuelle sous Debian
- Tester le serveur localement avec des clients
- Mettre en place les premiers outils r√©seau (UFW)

### 1. Cr√©ation d‚Äôune machine virtuelle Debian 11
- Hyperviseur : VirtualBox (ou autre)
- Nom : `Classcord`
- Type : Linux / Debian (64-bit)
- RAM : 2 Go
- Disque dur : 20 Go (VDI, allou√© dynamiquement)
- R√©seau :
  - **Adaptateur 1** : NAT
  - **Adaptateur 2** : R√©seau priv√© h√¥te

### 2. Installation de Debian
- Langue : Fran√ßais
- Localisation : France
- Clavier : Fran√ßais
- Partition : Guid√©e ‚Äì utiliser tout le disque
- Environnement de bureau : Aucun
- Activer serveur SSH

### 3. Installation des outils essentiels
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y git curl python3 python3-pip ufw
```

### 4. Clonage du projet serveur
```bash
git clone https://github.com/AstrowareConception/classcord-server.git
cd classcord-server
```

### 5. Lancement du serveur Python
```bash
python3 server_classcord.py
```

### 6. Test multi-clients
- Port utilis√© : `12345`
- Connexion client via JSON
- Logs affich√©s dans la console

### 7. V√©rification r√©seau et ouverture du port
```bash
ss -tulpn | grep 12345
sudo ufw allow 12345/tcp
```

---

## üìó Jour 2 - Mardi : D√©ploiement r√©seau, automatisation et Docker

### Objectifs p√©dagogiques
- D√©ployer le serveur sur r√©seau p√©dagogique
- Automatiser avec systemd
- Conteneuriser avec Docker
- Documenter l'acc√®s

### 1. V√©rification de l‚Äô√©coute r√©seau
```bash
sudo ufw allow 12345/tcp
ss -tulpn | grep 12345
hostname -I
```

### 2. Cr√©ation d‚Äôun utilisateur d√©di√©
```bash
sudo useradd -m classcord
sudo passwd classcord
su - classcord
```

### 3. Cr√©ation du service systemd
Fichier : `/etc/systemd/system/classcord.service`
```ini
[Unit]
Description=Serveur ClassCord
After=network.target

[Service]
User=classcord
WorkingDirectory=/home/classcord/classcord-server
ExecStart=/usr/bin/python3 /home/classcord/classcord-server/server_classcord.py
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

Activation :
```bash
sudo systemctl daemon-reexec
sudo systemctl enable --now classcord.service
```

### 4. Dockerfile (racine du projet)
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY . /app
RUN pip install --no-cache-dir -r requirements.txt || true
EXPOSE 12345
CMD ["python", "server_classcord.py"]
```

### 5. docker-compose.yml
```yaml
version: '3'
services:
  classcord:
    build: .
    ports:
      - "12345:12345"
    restart: unless-stopped
```

### 6. Tests
```bash
docker build -t classcord-server .
docker run -it --rm -p 12345:12345 classcord-server
```

Fichiers √† produire : `doc_connexion.md`, `CONTAINERS.md`

---

## üìñ Jour 3 - Mercredi : S√©curisation, journalisation et monitoring

### Objectifs
- Logger tous les √©v√©nements
- Prot√©ger avec fail2ban
- Sauvegarder automatiquement `users.pkl`
- Automatiser avec cron

### 1. Configuration des logs (Python)
```python
import logging
logger = logging.getLogger(__name__)
logger.setLevel(logging.INFO)
formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
file_handler = logging.FileHandler('/var/log/classcord/classcord.log')
file_handler.setFormatter(formatter)
logger.addHandler(file_handler)
```

Cr√©er le dossier :
```bash
sudo mkdir -p /var/log/classcord
sudo chown -R classcord:classcord /var/log/classcord
```

### 2. Rotation des logs avec logrotate
Fichier `/etc/logrotate.d/classcord` :
```conf
/var/log/classcord/classcord.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 classcord classcord
    postrotate
        systemctl restart classcord.service
    endscript
}
```

### 3. Fail2ban

Fichier `/etc/fail2ban/filter.d/classcord.conf` :
```conf
[Definition]
failregex = \[LOGIN\] Failed login attempt from <HOST>
ignoreregex =
```

Fichier `/etc/fail2ban/jail.local` :
```conf
[classcord]
enabled = true
port = 12345
filter = classcord
logpath = /var/log/classcord/classcord.log
maxretry = 3
findtime = 300
bantime = 3600
```

### 4. Sauvegarde automatique (cron)
```bash
crontab -e
```

Ajouter :
```cron
0 * * * * cp /home/classcord/classcord-server/users.pkl /home/classcord/backups/users-$(date +\%F-\%H\%M).pkl
```

### 5. Outils de surveillance utiles
```bash
sudo tail -f /var/log/classcord/classcord.log
sudo fail2ban-client status classcord
sudo systemctl status classcord.service
sudo journalctl -u classcord.service -f
```

---


## üìò Jour 4 ‚Äì Jeudi : Am√©liorations fonctionnelles, personnalisation et administration

### üéØ Objectifs p√©dagogiques
- G√©rer les canaux de discussion c√¥t√© serveur
- Stocker de fa√ßon persistante les utilisateurs et messages
- Mettre en place un menu administrateur
- Cr√©er un script d‚Äôexport CSV
- G√©rer la d√©connexion des clients et l‚Äôarr√™t du serveur

---

### üß† 1. Gestion des canaux

Structure cr√©√©e dans le code :
```python
CHANNELS = {'#g√©n√©ral': [], '#dev': [], '#admin': []}
```

Adaptation du serveur pour :
- Attribuer un canal √† chaque client connect√©
- Diffuser uniquement aux clients pr√©sents dans le m√™me canal

Extrait :
```python
def broadcast(message, channel=None, exclude=None):
    targets = CHANNELS[channel] if channel else sum(CHANNELS.values(), [])
    for client in targets:
        if client != exclude:
            ...
```

---

### üõ†Ô∏è 2. Stockage persistant avec SQLite

Commandes :
```bash
mkdir -p config/database
```

Initialisation automatique dans le script :
```python
DB_PATH = 'config/database/classcord.db'
```

Cr√©ation des tables :
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL
);

CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    channel TEXT,
    content TEXT,
    timestamp TEXT,
    FOREIGN KEY(user_id) REFERENCES users(id)
);
```

Les mots de passe sont hach√©s en SHA256 :
```python
def hash_password(pwd):
    return hashlib.sha256(pwd.encode()).hexdigest()
```

---

### üñ•Ô∏è 3. Console administrateur (menu int√©gr√©)

Ajout dans le serveur :
```python
def admin_console():
    while True:
        print("1. Voir les clients connect√©s")
        print("2. Voir l'√©tat des canaux")
        print("3. Voir les utilisateurs et messages")
        ...
```

Accessible en parall√®le via un `thread` :
```python
threading.Thread(target=admin_console, daemon=True).start()
```

---

### üìã 4. Script `admin_view.py`

Fonction :
- Affiche les utilisateurs et les messages r√©cents
- Utilise `sqlite3` et `tabulate`

Installation de la d√©pendance :
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install tabulate
```

Utilisation :
```bash
python3 admin_view.py
```

---

### üì¶ 5. Export CSV des messages et utilisateurs

Fichiers g√©n√©r√©s automatiquement :
- `scripts/exports/messages_export_YYYY-MM-DD.csv`
- `scripts/exports/users_export_YYYY-MM-DD.csv`

Structure cr√©√©e :
```bash
mkdir -p scripts/exports
```

Code :
```python
with open(f"scripts/exports/messages_export_{date.today()}.csv", "w") as f:
    writer = csv.writer(f)
    ...
```

---

### üîÅ 6. Notification des clients √† l'arr√™t

Lorsqu‚Äôun administrateur arr√™te le serveur :
```python
for sock in list(CLIENTS.keys()):
    try:
        send_json(sock, {"type": "shutdown", "message": "Serveur arr√™t√©."})
    except:
        pass
```

Les clients re√ßoivent un message de fin et ferment leur socket.

---

### ‚úÖ R√©sum√© des livrables
- Serveur avec gestion de canaux
- Authentification s√©curis√©e par hash
- Menu administrateur int√©gr√©
- Base de donn√©es SQLite fonctionnelle
- Script `admin_view.py` utilisable
- Export CSV automatis√©

---
## üìò Jour 5 ‚Äì Vendredi : Finalisation, automatisation syst√®me et bilan

### üéØ Objectifs p√©dagogiques
- Int√©grer le serveur dans le syst√®me (systemd)
- Automatiser le d√©marrage et le red√©marrage en cas d‚Äô√©chec
- V√©rifier la stabilit√© multi-clients
- Documenter tout le projet de mani√®re claire
- Exporter les donn√©es (utilisateurs, messages)
- S‚Äôassurer de la s√©curit√© et du suivi du serveur

---

### üõ†Ô∏è 1. Service systemd

Cr√©ation du fichier :
```bash
sudo nano /etc/systemd/system/classcord.service
```

Contenu :
```ini
[Unit]
Description=Serveur ClassCord
After=network.target

[Service]
User=classcord
WorkingDirectory=/home/classcord/classcord-server
ExecStart=/usr/bin/python3 /home/classcord/classcord-server/server_classcord.py
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

Commandes :
```bash
sudo systemctl daemon-reexec
sudo systemctl enable --now classcord.service
```

V√©rification :
```bash
sudo systemctl status classcord.service
sudo journalctl -u classcord.service -f
```

---

### üß™ 2. Test multi-clients (fonctionnel)

- Lancement simultan√© de plusieurs `test_client.py`
- Chaque client peut :
  - s‚Äôenregistrer
  - se connecter
  - envoyer/recevoir des messages en temps r√©el
  - changer de canal

Exemple de r√©ception :
```json
{ "type": "message", "from": "lia", "channel": "#g√©n√©ral", "content": "salut leo", "timestamp": "..." }
```

---

### üì§ 3. Exportation des donn√©es

Dans l‚Äôinterface console (admin) :
```text
3. Voir les utilisateurs et messages
```

‚û°Ô∏è G√©n√®re :
- `scripts/exports/messages_export_2025-06-20.csv`
- `scripts/exports/users_export_2025-06-20.csv`

---

### üßæ 4. Journalisation compl√®te

| Fichier                     | Contenu                                                                 |
|----------------------------|-------------------------------------------------------------------------|
| `logs/classcord.log`       | Activit√© standard du serveur                                            |
| `logs/audit.log`           | Actions administratives (alerte, changement canal, arr√™t serveur...)   |
| `logs/debug.log`           | Infos d√©taill√©es, erreurs de threads, exceptions techniques             |
| `logs/server_stdout.log`   | Sortie standard du serveur (si lanc√© via `start_server.sh`)            |

Commandes utiles :
```bash
tail -f logs/classcord.log
tail -f logs/audit.log
```

---

### üßπ 5. Nettoyage et s√©curit√© finale

- Suppression de `users.pkl` si encore pr√©sent
```bash
rm users.pkl
```

- V√©rification des permissions sur la base SQLite :
```bash
chmod 600 config/database/classcord.db
```

- V√©rification des ports :
```bash
ss -tulpn | grep 12345
```

- Activation pare-feu :
```bash
sudo ufw allow 12345/tcp
sudo ufw enable
```

---

### ‚úÖ R√©sum√© des livrables
- Serveur stable et multi-clients
- Donn√©es utilisateurs/messages persistantes
- Export CSV automatis√©
- Interface console op√©rationnelle
- D√©marrage automatique avec systemd
- Journalisation compl√®te et filtrable

---

## üóÇ Arborescence projet
```
classcord-server/
‚îú‚îÄ‚îÄ server_classcord.py
‚îú‚îÄ‚îÄ test_client.py
‚îú‚îÄ‚îÄ admin_view.py
‚îú‚îÄ‚îÄ start_server.sh
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ fail2ban/
‚îÇ   ‚îú‚îÄ‚îÄ logrotate/
‚îÇ   ‚îî‚îÄ‚îÄ systemd/
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îú‚îÄ‚îÄ audit.log
‚îÇ   ‚îú‚îÄ‚îÄ debug.log
‚îÇ   ‚îú‚îÄ‚îÄ classcord.log
‚îÇ   ‚îî‚îÄ‚îÄ server_stdout.log
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ exports/
‚îÇ       ‚îú‚îÄ‚îÄ messages_YYYY-MM-DD.csv
‚îÇ       ‚îî‚îÄ‚îÄ users_YYYY-MM-DD.csv
```

---

## ‚úÖ Conclusion

- Projet pr√™t √† d√©ployer et document√©
- Fonctionnalit√©s avanc√©es : multi-clients, s√©curit√©, logging, base de donn√©es
- Livrables disponibles pour √©valuation
